---
layout: post
title: 前端灰度发布方案
category: k8s
tags: [ k8s ]
no-post-nav: true
---

# 前端灰度发布方案

## 一.方案描述

前端发布过程中会优先发布一个auto-canary服务,auto-canary与正常服务相同,使用的是最新版本的镜像.除此之后会在auto-canary的容器nginx配置中添加
nginx配置add_header设置特定的Cookie键值对**sp-canary=always**,当请求进入auto-canary容器后,都会带上这个特定的Cookie.

然后我们在ingress-nginx
上配置**nginx.ingress.kubernetes.io/canary-by-cookie**,当带有**sp-canary=always**的Cookie时将该请求路由到auto-canary容器.

## 二.方案实施步骤

### 1.配置ingress-nginx的annotations

ingress-nginx中支持金丝雀发布,

* nginx.ingress.kubernetes.io/canary: 是否启用金丝雀发布
* nginx.ingress.kubernetes.io/canary-by-cookie: 判断是否进行金丝雀路由的Cookie名称,值为always时路由,never时不进行金丝雀路由

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ingress-nginx
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-by-cookie: "sp-canary"
```

[相关ingress-nginx文档](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#canary)

### 2.前端auto-canary容器发布时nginx增加cookies响应头

在前端canary服务的nginx容器中通过add_header设置Set-Cookie的响应头,将sp-canary的值设置为always

```
add_header Set-Cookie "sp-canary=true"
```

示例:

```nginx
server {
    listen 8080;
    server_name ${domian};
    location / {
       add_header Set-Cookie "sp-canary=always";
       root /app;
    }
  }
```